{% extends 'layout.html' %}
{% block content %}
<div class="max-w-4xl mx-auto mt-6 px-2 sm:px-4">

    <!-- Unified container for post and replies -->
    <div class="bg-white/90 border border-teal-200 rounded-xl shadow-md backdrop-blur-sm overflow-hidden mb-5">
        
        <!-- Top Bar with Back Arrow -->
        <div class="p-4 border-b border-teal-100">
            <a href="{% url 'forums' %}" class="flex items-center gap-2 text-teal-700 hover:text-teal-900 font-semibold transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                <span>Back</span>
            </a>
        </div>

        <div class="p-4 flex gap-3">
            <!-- Content Section -->
            <div class="flex-grow">
                <div class="text-xs text-gray-500 mb-3">
                    Posted by <span class="font-semibold text-teal-700">{{ post.owner }}</span>
                    <span class="mx-1">&bull;</span>
                    <span>{{ post.time }} on {{ post.date }}</span>
                </div>
                <p class="text-xl font-semibold text-teal-900 break-words">{{ post.body }}</p>
            </div>
        </div>

        <!-- Comment Button and Reply Form -->
        <div class="p-4 border-t border-teal-100">
            <button id="comment-button" class="w-full text-left px-4 py-2 rounded-lg bg-teal-50 hover:bg-teal-100 text-gray-500 transition">
                Add a comment...
            </button>
            <div id="reply-form-container" class="hidden mt-3">
                <form method="POST">
                    {% csrf_token %}
                    <textarea
                        name="reply"
                        placeholder="Share your thoughts..."
                        class="w-full resize-y rounded-lg border border-teal-200 bg-white text-gray-800 p-3 focus:ring-2 focus:ring-teal-600 focus:outline-none transition"
                        rows="4"
                    ></textarea>
                    <div class="flex justify-end items-center mt-3">
                        <button class="px-5 py-2 font-bold rounded-lg bg-gradient-to-tr from-teal-600 to-teal-500 hover:from-teal-700 hover:to-teal-600 text-white shadow transition transform hover:scale-105">
                            Post Reply
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Replies Section -->
        <div class="p-4 space-y-5">
            <h2 class="text-lg font-bold text-teal-900 pb-2 border-b border-teal-100">Replies</h2>

            {% if page_obj.object_list %}
                {% for reply in page_obj.object_list %}
                <div class="flex gap-3">
                    
                    <!-- Reply Content -->
                    <div class="flex-grow">
                        <div class="text-xs text-gray-500 mb-1">
                            <span class="font-semibold text-teal-700">{{ reply.owner }}</span>
                            &bull; {{ reply.time }} | {{ reply.date }}
                        </div>
                        <p class="text-gray-800 break-words">{{ reply }}</p>
                    </div>
                </div>
                {% endfor %}

                <!-- Pagination -->
                {% if page_obj.paginator.num_pages > 1 %}
                <div class="flex justify-center items-center gap-4 pt-4 border-t border-teal-100 text-sm">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}"
                            class="px-3 py-1 rounded bg-teal-100 hover:bg-teal-200 text-teal-800 font-semibold transition">
                            ← Previous
                        </a>
                    {% endif %}
                    <span class="font-medium text-gray-600">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}"
                            class="px-3 py-1 rounded bg-teal-100 hover:bg-teal-200 text-teal-800 font-semibold transition">
                            Next →
                        </a>
                    {% endif %}
                </div>
                {% endif %}

            {% else %}
                <p class="text-gray-500 italic text-center py-4">Be the first one to reply!</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Set user timezone cookie
    document.cookie =
        "user_timezone=" +
        Intl.DateTimeFormat().resolvedOptions().timeZone +
        ";path=/";

    // Logic to show/hide comment form
    document.addEventListener('DOMContentLoaded', function() {
        const commentButton = document.getElementById('comment-button');
        const replyFormContainer = document.getElementById('reply-form-container');
        const replyTextarea = replyFormContainer.querySelector('textarea');

        commentButton.addEventListener('click', (event) => {
            // Stop the click from bubbling up to the window listener
            event.stopPropagation(); 
            // Hide the button and show the form
            commentButton.classList.add('hidden');
            replyFormContainer.classList.remove('hidden');
            // Automatically focus the textarea for a better user experience
            replyTextarea.focus();
        });

        // Add a click listener to the whole window to detect outside clicks
        window.addEventListener('click', (event) => {
            // Check if the reply form is visible AND if the click was outside of it
            if (!replyFormContainer.classList.contains('hidden') && !replyFormContainer.contains(event.target)) {
                replyFormContainer.classList.add('hidden');
                commentButton.classList.remove('hidden');
            }
        });

        // Prevent the form itself from closing when clicked inside
        replyFormContainer.addEventListener('click', (event) => {
            event.stopPropagation();
        });
    });
</script>
{% endblock %}
